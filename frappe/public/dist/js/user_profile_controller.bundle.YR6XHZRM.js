(()=>{var _=class{constructor(e){Object.assign(this,e),this.make()}make(){this.timeline_wrapper=$('<div class="new-timeline">'),this.wrapper=this.timeline_wrapper,this.timeline_items_wrapper=$('<div class="timeline-items">'),this.timeline_actions_wrapper=$(`
			<div class="timeline-items timeline-actions">
				<div class="timeline-item">
					<div class="timeline-dot"></div>
					<div class="timeline-content action-buttons"></div>
				</div>
			</div>
		`),this.timeline_wrapper.append(this.timeline_actions_wrapper),this.timeline_actions_wrapper.hide(),this.timeline_wrapper.append(this.timeline_items_wrapper),this.parent.replaceWith(this.timeline_wrapper),this.timeline_items=[]}refresh(){this.render_timeline_items()}add_action_button(e,t,i=null,s=null){let a=i?frappe.utils.icon(i,"xs"):null;this.timeline_actions_wrapper.show();let r=$(`<button class="btn btn-xs ${s||"btn-default"} action-btn">
			${a}
			${e}
		</button>`);return r.click(t),this.timeline_actions_wrapper.find(".action-buttons").append(r),r}render_timeline_items(){this.timeline_items_wrapper.empty(),this.timeline_items=[],this.doc_info=this.frm&&this.frm.get_docinfo()||{};let e=this.prepare_timeline_contents();e instanceof Promise?e.then(()=>{this.timeline_items.sort((t,i)=>new Date(i.creation)-new Date(t.creation)),this.timeline_items.forEach(this.add_timeline_item.bind(this))}):(this.timeline_items.sort((t,i)=>new Date(i.creation)-new Date(t.creation)),this.timeline_items.forEach(this.add_timeline_item.bind(this)))}prepare_timeline_contents(){}add_timeline_item(e,t=!1){let i=this.get_timeline_item(e);return t?this.timeline_items_wrapper.append(i):this.timeline_items_wrapper.prepend(i),i}add_timeline_items(e,t=!1){e.forEach(i=>this.add_timeline_item(i,t))}get_timeline_item(e){let t=$('<div class="timeline-item">');t.attr({"data-doctype":e.doctype,"data-name":e.name}),e.icon?t.append(`
				<div class="timeline-badge" title='${e.title||frappe.utils.to_title_case(e.icon)}'>
					${frappe.utils.icon(e.icon,e.icon_size||"md")}
				</div>
			`):e.timeline_badge?t.append(e.timeline_badge):t.append('<div class="timeline-dot">'),t.append(`<div class="timeline-content ${e.is_card?"frappe-card":""}">`);let i=t.find(".timeline-content");return i.append(e.content),!e.hide_timestamp&&!e.is_card&&i.append(`<span> - ${comment_when(e.creation)}</span>`),e.id&&i.attr("id",e.id),t}},p=_;frappe.provide("frappe.energy_points");var l=class{constructor(e){this.wrapper=$(e),this.page=frappe.ui.make_app_page({parent:e}),this.sidebar=this.wrapper.find(".layout-side-section"),this.main_section=this.wrapper.find(".layout-main-section"),this.wrapper.bind("show",()=>{this.show()})}show(){let e=frappe.get_route();this.user_id=e[1]||frappe.session.user,frappe.dom.freeze(__("Loading user profile")+"..."),frappe.db.exists("User",this.user_id).then(t=>{frappe.dom.unfreeze(),t?this.make_user_profile():frappe.msgprint(__("User does not exist"))})}make_user_profile(){this.user=frappe.user_info(this.user_id),this.page.set_title(this.user.fullname),this.setup_user_search(),this.main_section.empty().append(frappe.render_template("user_profile")),this.energy_points=0,this.review_points=0,this.rank=0,this.month_rank=0,this.render_user_details(),this.render_points_and_rank(),this.render_heatmap(),this.render_line_chart(),this.render_percentage_chart("type","Type Distribution"),this.create_percentage_chart_filters(),this.setup_user_activity_timeline()}setup_user_search(){this.$user_search_button=this.page.set_secondary_action(__("Change User"),()=>this.show_user_search_dialog(),{icon:"change",size:"sm"})}show_user_search_dialog(){let e=new frappe.ui.Dialog({title:__("Change User"),fields:[{fieldtype:"Link",fieldname:"user",options:"User",label:__("User")}],primary_action_label:__("Go"),primary_action:({user:t})=>{e.hide(),frappe.set_route("user-profile",t)}});e.show()}render_heatmap(){this.heatmap=new frappe.Chart(".performance-heatmap",{type:"heatmap",countLabel:"Energy Points",data:{},discreteDomains:1,radius:3,height:150}),this.update_heatmap_data(),this.create_heatmap_chart_filters()}update_heatmap_data(e){frappe.xcall("frappe.desk.page.user_profile.user_profile.get_energy_points_heatmap_data",{user:this.user_id,date:e||frappe.datetime.year_start()}).then(t=>{this.heatmap.update({dataPoints:t})})}render_line_chart(){this.line_chart_filters=[["Energy Point Log","user","=",this.user_id,!1],["Energy Point Log","type","!=","Review",!1]],this.line_chart_config={timespan:"Last Month",time_interval:"Daily",type:"Line",value_based_on:"points",chart_type:"Sum",document_type:"Energy Point Log",name:"Energy Points",width:"half",based_on:"creation"},this.line_chart=new frappe.Chart(".performance-line-chart",{type:"line",height:200,data:{labels:[],datasets:[{}]},colors:["purple"],axisOptions:{xIsSeries:1}}),this.update_line_chart_data(),this.create_line_chart_filters()}update_line_chart_data(){this.line_chart_config.filters_json=JSON.stringify(this.line_chart_filters),frappe.xcall("frappe.desk.doctype.dashboard_chart.dashboard_chart.get",{chart:this.line_chart_config,no_cache:1}).then(e=>{this.line_chart.update(e)})}render_percentage_chart(e,t){frappe.xcall("frappe.desk.page.user_profile.user_profile.get_energy_points_percentage_chart_data",{user:this.user_id,field:e}).then(i=>{i.labels.length?this.percentage_chart=new frappe.Chart(".performance-percentage-chart",{type:"percentage",data:{labels:i.labels,datasets:i.datasets},truncateLegends:1,barOptions:{height:11,depth:1},height:200,maxSlices:8,colors:["purple","blue","cyan","teal","pink","red","orange","yellow"]}):this.wrapper.find(".percentage-chart-container").hide()})}create_line_chart_filters(){let e=[{label:"All",options:["All","Auto","Criticism","Appreciation","Revert"],action:t=>{t==="All"?this.line_chart_filters=[["Energy Point Log","user","=",this.user_id,!1],["Energy Point Log","type","!=","Review",!1]]:this.line_chart_filters[1]=["Energy Point Log","type","=",t,!1],this.update_line_chart_data()}},{label:"Last Month",options:["Last Week","Last Month","Last Quarter","Last Year"],action:t=>{this.line_chart_config.timespan=t,this.update_line_chart_data()}},{label:"Daily",options:["Daily","Weekly","Monthly"],action:t=>{this.line_chart_config.time_interval=t,this.update_line_chart_data()}}];frappe.dashboard_utils.render_chart_filters(e,"chart-filter",".line-chart-options",1)}create_percentage_chart_filters(){let e=[{label:"Type",options:["Type","Reference Doctype","Rule"],fieldnames:["type","reference_doctype","rule"],action:(t,i)=>{let s=t+" Distribution";this.render_percentage_chart(i,s)}}];frappe.dashboard_utils.render_chart_filters(e,"chart-filter",".percentage-chart-options")}create_heatmap_chart_filters(){let e=[{label:frappe.dashboard_utils.get_year(frappe.datetime.now_date()),options:frappe.dashboard_utils.get_years_since_creation(frappe.boot.user.creation),action:t=>{this.update_heatmap_data(frappe.datetime.obj_to_str(t))}}];frappe.dashboard_utils.render_chart_filters(e,"chart-filter",".heatmap-options")}edit_profile(){let e=new frappe.ui.Dialog({title:__("Edit Profile"),fields:[{fieldtype:"Attach Image",fieldname:"user_image",label:"Profile Image"},{fieldtype:"Data",fieldname:"interest",label:"Interests"},{fieldtype:"Column Break"},{fieldtype:"Data",fieldname:"location",label:"Location"},{fieldtype:"Section Break",fieldname:"Interest"},{fieldtype:"Small Text",fieldname:"bio",label:"Bio"}],primary_action:t=>{e.disable_primary_action(),frappe.xcall("frappe.desk.page.user_profile.user_profile.update_profile_info",{profile_info:t}).then(i=>{i.image=i.user_image,this.user=Object.assign(t,i),e.hide(),this.render_user_details()}).finally(()=>{e.enable_primary_action()})},primary_action_label:__("Save")});e.set_values({user_image:this.user.image,location:this.user.location,interest:this.user.interest,bio:this.user.bio}),e.show()}render_user_details(){this.sidebar.empty().append(frappe.render_template("user_profile_sidebar",{user_image:this.user.image,user_abbr:this.user.abbr,user_location:this.user.location,user_interest:this.user.interest,user_bio:this.user.bio})),this.setup_user_profile_links()}setup_user_profile_links(){this.user_id!==frappe.session.user?this.wrapper.find(".profile-links").hide():(this.wrapper.find(".edit-profile-link").on("click",()=>{this.edit_profile()}),this.wrapper.find(".user-settings-link").on("click",()=>{this.go_to_user_settings()}))}get_user_rank(){return frappe.xcall("frappe.desk.page.user_profile.user_profile.get_user_rank",{user:this.user_id}).then(e=>{e.monthly_rank.length&&(this.month_rank=e.monthly_rank[0]),e.all_time_rank.length&&(this.rank=e.all_time_rank[0])})}get_user_points(){return frappe.xcall("frappe.social.doctype.energy_point_log.energy_point_log.get_user_energy_and_review_points",{user:this.user_id}).then(e=>{e[this.user_id]&&(this.energy_points=e[this.user_id].energy_points,this.review_points=e[this.user_id].review_points)})}render_points_and_rank(){let e=this.wrapper.find(".user-stats"),t=this.wrapper.find(".user-stats-detail"),i=(s,a,r)=>`<div class="user-stats-item mt-4">
				${frappe.utils.icon(r,"lg","no-stroke")}
				<div>
					<div class="stat-value">${s}</div>
					<div class="stat-label">${a}</div>
				</div>
			</div>`;this.get_user_rank().then(()=>{this.get_user_points().then(()=>{let s=$(`
					${i(this.energy_points,__("Energy Points"),"color-energy-points")}
					${i(this.review_points,__("Review Points"),"color-review-points")}
					${i(this.rank,__("Rank"),"color-rank")}
					${i(this.month_rank,__("Monthly Rank"),"color-monthly-rank")}
				`);e.append(s),t.removeClass("hide")})})}go_to_user_settings(){frappe.set_route("Form","User",this.user_id)}setup_user_activity_timeline(){this.user_activity_timeline=new o({parent:this.wrapper.find(".recent-activity-list"),footer:this.wrapper.find(".recent-activity-footer"),user:this.user_id}),this.user_activity_timeline.refresh()}},o=class extends p{make(){super.make(),this.activity_start=0,this.activity_limit=20,this.setup_show_more_activity()}prepare_timeline_contents(){return this.get_user_activity_data().then(e=>{if(!e.length){this.show_more_button.hide(),this.timeline_wrapper.html(`<div>${__("No activities to show")}</div>`);return}this.show_more_button.toggle(e.length===this.activity_limit),this.timeline_items=e.map(t=>this.get_activity_timeline_item(t))})}get_user_activity_data(){return frappe.xcall("frappe.desk.page.user_profile.user_profile.get_energy_points_list",{start:this.activity_start,limit:this.activity_limit,user:this.user})}get_activity_timeline_item(e){return{icon:e.type=="Appreciation"?"clap":e.type=="Criticism"?"criticize":null,creation:e.creation,is_card:!0,content:frappe.energy_points.format_history_log(e)}}setup_show_more_activity(){this.show_more_button=$(`<a class="show-more-activity-btn">${__("Show More Activity")}</a>`),this.show_more_button.hide(),this.footer.append(this.show_more_button),this.show_more_button.on("click",()=>this.show_more_activity())}show_more_activity(){this.activity_start+=this.activity_limit,this.get_user_activity_data().then(e=>{(!e.length||e.length<this.activity_limit)&&this.show_more_button.hide(),e.map(i=>this.get_activity_timeline_item(i)).map(i=>this.add_timeline_item(i,!0))})}};frappe.provide("frappe.ui");frappe.ui.UserProfile=l;})();
//# sourceMappingURL=user_profile_controller.bundle.YR6XHZRM.js.map
